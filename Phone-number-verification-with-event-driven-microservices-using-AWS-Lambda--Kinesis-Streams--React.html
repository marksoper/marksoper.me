<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Phone number verification - event-driven microservices - AWS Lambda, Kinesis Streams, React.js</title>

        <link rel="canonical" />
        <link rel="stylesheet" type="text/css" href="site.css" />
        <link rel="stylesheet" type="text/css" href="blog.css" />

<script src="site.js"></script>

    </head>
    <body>

     <div class="header">

      <div class="title">
        <a href="./" title="Mark Soper">
          <h1>Mark Soper
            <br>
            <span class="profession">
              Software Engineer
            </span>
            <br>
            <span class="location">
              Cambridge, MA
            </span>
          </h1>
        </a>
      </div>

      <div class="nav">
        <ul>

          <li>
            <a href="./#contact" title="Contact Mark Soper">
              Contact
            </a>
          </li>

          <li>
            <a href="./#blog" title="Mark Soper's Blog">
              Blog
            </a>
          </li>

          <li>
            <a href="./#projects" title="Mark Soper's Projects">
              Projects
            </a>
          </li>

        </ul>
      </div>

    </div>


        <div class="container">


                          <div class="articleHeader">
    <div class="articleTitle">
                  <h1>Phone number verification with event-driven microservices using AWS Lambda, Kinesis Streams, React.js</h1>
    </div>

    <div class="articleDate">
                  <div class="articleWeekday">
                    Monday
                  </div>
                  <div class="articleDay">
                    Sep 18
                  </div>
                  <div class="articleYear">,
                    2017
                  </div>
    </div>
        </div>

        <section name="e52b" class="section section--body section--first section--last"><div class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><figure name="55a3" id="55a3" class="graf graf--figure graf-after--h3"><img width="100%" src="media/images/verif.png" /></div><figcaption class="imageCaption">AWS Lambda + CloudFront + Kinesis + DynamoDB architecture — phone number verification Web App &amp; SMS</figcaption></figure>
          <br><Br>
          <p name="6fd4" id="6fd4" class="graf graf--p graf-after--figure">I recently built a <a href="https://github.com/marksoper/phone-verification" data-href="https://github.com/marksoper/phone-verification" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">prototype web app that performs <em class="markup--em markup--p-em">phone number verification</em></a> using an event-driven architecture pattern in Node.js on AWS Lambda with AWS Kinesis streams. This might be interesting if you are:</p><ul class="postList"><li name="5f9f" id="5f9f" class="graf graf--li graf-after--p">looking for an example implementation of <a href="https://en.wikipedia.org/wiki/Telephone_number_verification" data-href="https://en.wikipedia.org/wiki/Telephone_number_verification" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">phone number verification</a><br><strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em">For learning purposes, code not meant to be used in production!</em></strong></li><li name="9fce" id="9fce" class="graf graf--li graf-after--li">interested in <a href="https://www.oreilly.com/ideas/the-evolution-of-scalable-microservices" data-href="https://www.oreilly.com/ideas/the-evolution-of-scalable-microservices" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">event-driven microservices</a></li><li name="ea08" id="ea08" class="graf graf--li graf-after--li">building <a href="https://martinfowler.com/articles/serverless.html" data-href="https://martinfowler.com/articles/serverless.html" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">serverless</a> (<a href="https://en.wikipedia.org/wiki/Function_as_a_Service" data-href="https://en.wikipedia.org/wiki/Function_as_a_Service" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">FaaS</a>) functions with <a href="https://aws.amazon.com/lambda/" data-href="https://aws.amazon.com/lambda/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">AWS Lambda</a></li><li name="69ee" id="69ee" class="graf graf--li graf-after--li">using <a href="https://en.wikipedia.org/wiki/Event-driven_architecture" data-href="https://en.wikipedia.org/wiki/Event-driven_architecture" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">event-driven architecture</a> patterns with <a href="https://docs.aws.amazon.com/streams/latest/dev/introduction.html" data-href="https://docs.aws.amazon.com/streams/latest/dev/introduction.html" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">AWS Kinesis Streams</a></li></ul><h3 name="2d13" id="2d13" class="graf graf--h3 graf-after--li">Source Code</h3><p name="5170" id="5170" class="graf graf--p graf-after--h3"><a href="https://github.com/marksoper/phone-verification" data-href="https://github.com/marksoper/phone-verification" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><strong class="markup--strong markup--p-strong">phone-verification</strong> — phone number verification example project on Github</a></p><h3 name="fc23" id="fc23" class="graf graf--h3 graf-after--p">Full-stack Architecture</h3><h4 name="ae5a" id="ae5a" class="graf graf--h4 graf-after--h3">Front-end Web UI</h4><ul class="postList"><li name="2a00" id="2a00" class="graf graf--li graf-after--h4">a <a href="https://facebook.github.io/react/" data-href="https://facebook.github.io/react/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">React</a> web app in Javascript</li><li name="e517" id="e517" class="graf graf--li graf-after--li"><a href="https://github.com/catamphetamine/react-phone-number-input" data-href="https://github.com/catamphetamine/react-phone-number-input" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">react-phone-number-input</a> — React component for phone number entry</li><li name="3421" id="3421" class="graf graf--li graf-after--li">Build process: <a href="https://github.com/facebookincubator/create-react-app" data-href="https://github.com/facebookincubator/create-react-app" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">create-react-app</a>, <a href="https://github.com/prettier/prettier-eslint" data-href="https://github.com/prettier/prettier-eslint" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">prettier</a>, etc.</li></ul><h4 name="84bb" id="84bb" class="graf graf--h4 graf-after--li">Back-end Services</h4><ul class="postList"><li name="feca" id="feca" class="graf graf--li graf-after--h4"><a href="https://nodejs.org" data-href="https://nodejs.org" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Node.js</a></li><li name="23a6" id="23a6" class="graf graf--li graf-after--li"><a href="https://aws.amazon.com/lambda/" data-href="https://aws.amazon.com/lambda/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">AWS Lambda</a> Microservices</li><li name="8a6e" id="8a6e" class="graf graf--li graf-after--li"><a href="https://serverless.com/" data-href="https://serverless.com/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Serverless framework</a></li><li name="63be" id="63be" class="graf graf--li graf-after--li"><a href="https://aws.amazon.com/kinesis/streams/" data-href="https://aws.amazon.com/kinesis/streams/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">AWS Kinesis Streams</a></li><li name="1f1d" id="1f1d" class="graf graf--li graf-after--li"><a href="https://aws.amazon.com/dynamodb/" data-href="https://aws.amazon.com/dynamodb/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">AWS DynamoDB</a></li><li name="f9ed" id="f9ed" class="graf graf--li graf-after--li"><a href="https://www.plivo.com/" data-href="https://www.plivo.com/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Plivo SMS Gateway</a></li><li name="02f4" id="02f4" class="graf graf--li graf-after--li"><a href="https://www.davidbaumgold.com/tutorials/host-static-site-aws-s3-cloudfront/" data-href="https://www.davidbaumgold.com/tutorials/host-static-site-aws-s3-cloudfront/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">AWS S3 + Cloudfront Static Site Hosting</a></li></ul><h3 name="51c7" id="51c7" class="graf graf--h3 graf-after--li">Step-by-step guide to implementation</h3><h4 name="e9d7" id="e9d7" class="graf graf--h4 graf-after--h3">0. Prerequisites</h4><ul class="postList"><li name="3574" id="3574" class="graf graf--li graf-after--h4">AWS Account</li><li name="d4d1" id="d4d1" class="graf graf--li graf-after--li">Install and configure the <a href="https://aws.amazon.com/cli/" data-href="https://aws.amazon.com/cli/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">AWS CLI</a></li></ul><h4 name="84eb" id="84eb" class="graf graf--h4 graf-after--li">1. Deploy the web app</h4><ol class="postList"><li name="2d11" id="2d11" class="graf graf--li graf-after--h4">In the AWS Console, <a href="https://console.aws.amazon.com/s3" data-href="https://console.aws.amazon.com/s3" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">configure AWS S3</a> and <a href="https://console.aws.amazon.com/route53" data-href="https://console.aws.amazon.com/route53" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">AWS Route53</a> to establish static website hosting using a custom domain — see <a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/website-hosting-custom-domain-walkthrough.html" data-href="https://docs.aws.amazon.com/AmazonS3/latest/dev/website-hosting-custom-domain-walkthrough.html" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">detailed instructions</a>.</li><li name="49b1" id="49b1" class="graf graf--li graf-after--li">Setup AWS CloudFront to serve the static website. See <a href="https://www.davidbaumgold.com/tutorials/host-static-site-aws-s3-cloudfront/" data-href="https://www.davidbaumgold.com/tutorials/host-static-site-aws-s3-cloudfront/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Host a Static Site on AWS, using S3 and CloudFront</a> and then establish secure communication between the browser and web server <a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/using-https.html" data-href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/using-https.html" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Using HTTPS with CloudFront</a>.</li></ol><p name="d0d8" id="d0d8" class="graf graf--p graf-after--li">3. Clone, install, build, and deploy the web app.</p><pre name="45d4" id="45d4" class="graf graf--pre graf-after--p">$ git clone <a href="https://github.com/marksoper/phone-verification-app" data-href="https://github.com/marksoper/phone-verification-app" class="markup--anchor markup--pre-anchor" rel="noopener" target="_blank">https://github.com/marksoper/phone-verification</a><br>$ cd phone-verification<br>$ cd webapp<br>$ yarn install<br>$ yarn build<br>$ cd build<br>$ aws s3 cp ./ s3://&lt;your bucket/domain name&gt;/ --recursive</pre><h4 name="9b04" id="9b04" class="graf graf--h4 graf-after--pre">2. Setup the database in DynamoDB</h4><p name="efaf" id="efaf" class="graf graf--p graf-after--h4">In the AWS console, <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/SQLtoNoSQL.CreateTable.html" data-href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/SQLtoNoSQL.CreateTable.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">create a DynamoDB table</a></p><p name="aeb3" id="aeb3" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Table name</strong>: VerificationChallenges<br><strong class="markup--strong markup--p-strong">Primary partition key</strong>: createdDate (String)<br><strong class="markup--strong markup--p-strong">Primary sort key</strong>: smsCode (Number)</p><h4 name="2ae6" id="2ae6" class="graf graf--h4 graf-after--p">3. Create a Kinesis Event Stream</h4><p name="c4d5" id="c4d5" class="graf graf--p graf-after--h4">In the AWS console, <a href="https://console.aws.amazon.com/kinesis/" data-href="https://console.aws.amazon.com/kinesis/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">create a Kinesis stream</a></p><p name="ffe4" id="ffe4" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Table name</strong>: phone-verification-event-stream<br><strong class="markup--strong markup--p-strong">Number of shards</strong>: 1</p><h4 name="e20c" id="e20c" class="graf graf--h4 graf-after--p">4. Create an “event log” Log Group in CloudWatch</h4><p name="4c1c" id="4c1c" class="graf graf--p graf-after--h4">This is essentially optional. If you don’t want this you’ll need to remove the code in each of the Lambda functions that logs to this CloudWatch Log Group.</p><p name="95d0" id="95d0" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Log group name</strong>: verificationEventLog</p><h4 name="bb53" id="bb53" class="graf graf--h4 graf-after--p">5. Create Three Lambda services with Serverless framework</h4><p name="0726" id="0726" class="graf graf--p graf-after--h4">The send-sms-verification-code Lambda function requires access to the Plivo API. Plivo API account authentication credentials are kept out of version control in a file called config.js. See the instructions in the project README for the expected format of this file.</p><p name="95f5" id="95f5" class="graf graf--p graf-after--p">You should also consider using <a href="http://docs.aws.amazon.com/lambda/latest/dg/tutorial-env_console.html" data-href="http://docs.aws.amazon.com/lambda/latest/dg/tutorial-env_console.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">AWS Lambda’s environment variables</a> feature to make these credentials available. For this size app it probably doesn’t really matter, but for larger projects I would look carefully at both options.</p><p name="6c6a" id="6c6a" class="graf graf--p graf-after--p">Before creating the Lambda functions, you must edit the serverless.yml file, replacing &lt; region &gt; with your AWS region and &lt; AWS Account ID &gt; with your AWS account ID.</p><p name="cbf9" id="cbf9" class="graf graf--p graf-after--p">To create all 3 Lambda functions, from the repo root …</p><pre name="eecb" id="eecb" class="graf graf--pre graf-after--p">$ cd auth<br>$ serverless deploy -v</pre><p name="8b01" id="8b01" class="graf graf--p graf-after--pre">This will also create new <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html" data-href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">roles and policies</a> for these Lambda functions.</p><p name="6e33" id="6e33" class="graf graf--p graf-after--p"><em class="markup--em markup--p-em">NOTE — </em>at present Lambda does not support Node.js 7.x, so <a href="https://github.com/yortus/asyncawait" data-href="https://github.com/yortus/asyncawait" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">asyncawait</a> is used to allow async await capability a la es7 in the Lambda functions.</p><h4 name="15c5" id="15c5" class="graf graf--h4 graf-after--p">Lambda function — auth-request-verification-code</h4><p name="b823" id="b823" class="graf graf--p graf-after--h4">Once created, test the auth-request-verification-code function in the AWS Console Lambda page by choosing <em class="markup--em markup--p-em">Actions &gt; Configure Test Event</em> and entering input JSON:</p><pre name="8863" id="8863" class="graf graf--pre graf-after--p">{<br>    &quot;httpMethod&quot;: &quot;POST&quot;,<br>    &quot;body&quot;: {<br>        &quot;phoneNumber&quot;: &quot;&lt; your testing phone number here &gt;&quot;<br>    }<br>}</pre><h4 name="e609" id="e609" class="graf graf--h4 graf-after--pre">Lambda function — auth-send-sms-verification-code</h4><p name="ad08" id="ad08" class="graf graf--p graf-after--h4">The Serverless framework covers AWS Lambda definitions and associated roles/policies. But AFAIK it doesn’t deal with Kinesis mappings to those functions. Once both your auth-send-sms-verification-code Lambda function and your Kinesis stream are defined, you’ll need to update your Lambda to be invoked when stream records occur in Kinesis.</p><pre name="c46d" id="c46d" class="graf graf--pre graf-after--p">$ aws lambda create-event-source-mapping \<br>    — region &lt; enter your region here &gt; \<br>    — function-name auth-send-sms-verification-code \<br>    — event-source &lt; enter your kinesis stream ARN here &gt; \<br>    — starting-position TRIM_HORIZON</pre><p name="ad2d" id="ad2d" class="graf graf--p graf-after--pre">Once the mapping is created, it can be tested in the AWS Console using Actions &gt; Configure Test Event OR by running the auth-request-verification-code function and using the CloudWatch logs to debug the flow through Kinesis.</p><h4 name="f85b" id="f85b" class="graf graf--h4 graf-after--p">Lambda function — auth-verify-verification-code</h4><pre name="2224" id="2224" class="graf graf--pre graf-after--h4">{<br>    &quot;httpMethod&quot;: &quot;POST&quot;,<br>    &quot;body&quot;: {<br>        &quot;phoneNumber&quot;: &quot;&lt; your testing phone number &gt;&quot;,<br>        &quot;verificationCode&quot;: &quot;&lt; your verification code &gt;&quot;<br>    }<br>}</pre><h4 name="9444" id="9444" class="graf graf--h4 graf-after--pre">6. Testing</h4><h4 name="12b9" id="12b9" class="graf graf--h4 graf-after--h4">Front-end Web UI</h4><p name="20c6" id="20c6" class="graf graf--p graf-after--h4">Use standard <a href="https://facebook.github.io/jest/docs/en/tutorial-react.html" data-href="https://facebook.github.io/jest/docs/en/tutorial-react.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">create-react-app testing methodologies</a>, including unit tests and the local web deployment feature (<em class="markup--em markup--p-em">yarn start</em>) for dev and testing of the web app.</p><pre name="e1c8" id="e1c8" class="graf graf--pre graf-after--p">$ cd webapp<br>$ yarn install<br>$ npm test<br>$ yarn start</pre><h4 name="4185" id="4185" class="graf graf--h4 graf-after--pre">Lambda Functions</h4><p name="c24f" id="c24f" class="graf graf--p graf-after--h4">Lambda functions can be <a href="http://docs.aws.amazon.com/lambda/latest/dg/get-started-invoke-manually.html" data-href="http://docs.aws.amazon.com/lambda/latest/dg/get-started-invoke-manually.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">tested manually using both the CLI and AWS Console</a>. I used the AWS Console’s Lambda test invoke feature and CloudWatch Logs. A CloudWatch Log Group should be created automatically when you create the Lambda function.</p><p name="7632" id="7632" class="graf graf--p graf-after--p">Unit testing is challenging in AWS Lambda. I didn’t write any unit tests for this project. The are important implications on overall code organization — see this <a href="https://serverless.com/framework/docs/providers/aws/guide/testing/" data-href="https://serverless.com/framework/docs/providers/aws/guide/testing/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Unit testing guide from Serverless</a> for example — that I would pay attention to in larger production projects.</p><h3 name="fe9e" id="fe9e" class="graf graf--h3 graf-after--p">Further Reading</h3><h4 name="ef78" id="ef78" class="graf graf--h4 graf-after--h3">Event-driven microservices</h4><ul class="postList"><li name="f9c0" id="f9c0" class="graf graf--li graf-after--h4"><a href="https://mapr.com/blog/event-driven-microservices-patterns/" data-href="https://mapr.com/blog/event-driven-microservices-patterns/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">MapR — Event-driven microservices patterns</a></li><li name="c3f2" id="c3f2" class="graf graf--li graf-after--li"><a href="https://content.pivotal.io/blog/messaging-patterns-for-event-driven-microservices" data-href="https://content.pivotal.io/blog/messaging-patterns-for-event-driven-microservices" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Pivotal</a> — <a href="https://content.pivotal.io/blog/messaging-patterns-for-event-driven-microservices" data-href="https://content.pivotal.io/blog/messaging-patterns-for-event-driven-microservices" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Messaging Patterns for Event-Driven Microservices</a></li></ul><h4 name="d34d" id="d34d" class="graf graf--h4 graf-after--li">Event-driven architecture</h4><ul class="postList"><li name="069d" id="069d" class="graf graf--li graf-after--h4"><a href="https://en.wikipedia.org/wiki/Event-driven_architecture" data-href="https://en.wikipedia.org/wiki/Event-driven_architecture" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Wikipedia — Event-driven architecture</a></li><li name="fb28" id="fb28" class="graf graf--li graf-after--li"><a href="https://github.com/iluwatar/java-design-patterns/tree/master/event-driven-architecture" data-href="https://github.com/iluwatar/java-design-patterns/tree/master/event-driven-architecture" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Java design patterns — Event-driven architecture</a></li><li name="8bb3" id="8bb3" class="graf graf--li graf-after--li graf--trailing"><a href="https://dzone.com/articles/evaluating-message-brokers-kafka-vs-kinesis-vs-sqs" data-href="https://dzone.com/articles/evaluating-message-brokers-kafka-vs-kinesis-vs-sqs" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Evaluating Message Brokers: Kafka vs. Kinesis vs. SQS</a></li></ul>

          <br>
          <hr>
          <br>
          <br>
                    <p class="graf graf--p graf-after--figure">
                      <h3>Comments</h3>
                        <em>
                        This article is cross-posted on Medium. <b>Please comment there</b> at
                          <a title="Phone number verification with event-driven microservices using AWS Lambda, Kinesis Streams, React.js"
                            href="https://medium.com/@marksoper/phone-number-verification-with-aws-lambda-microservices-kinesis-dynamodb-node-js-and-react-js-bba0eb08ef92"
                          >
                           Phone number verification with event-driven microservices using AWS Lambda, Kinesis Streams, React.js.
                         </a>
                       </em>
                    </p>


        </div></div>

        </section>

        </section>



    </body>
</html>
